<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FreshChain – Food Traceability</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 1100px; margin: 30px auto; }
    button { padding: 8px 14px; margin-top: 6px; cursor: pointer; }
    input, select { padding: 6px; margin-top: 6px; }
    .box { margin-bottom: 25px; }
    pre { background: #f3f3f3; padding: 12px; }
    #status { padding: 10px; background: #f8f8f8; color: #b00000; margin-top: 10px; }
  </style>
</head>
<body>

<h1>FreshChain – Food Traceability</h1>

<button id="connectButton">Connect MetaMask</button>
<p id="accountDisplay">Not connected</p>
<p id="networkDisplay">Network: -</p>
<p id="status">Status: idle</p>

<hr>

<h3>Select User Type</h3>
<select id="roleSelect">
  <option value="">-- choose --</option>
  <option value="admin">Admin</option>
  <option value="producer">Producer</option>
  <option value="transporter">Transporter</option>
  <option value="distributor">Distributor</option>
  <option value="retailer">Retailer</option>
  <option value="customer">Customer</option>
</select>

<hr>

<!-- ADMIN -->
<div id="adminSection" class="box" style="display:none;">
  <h3>Admin – Register Roles</h3>

  <input id="producerAddress" placeholder="Producer address 0x..." size="55">
  <button onclick="registerProducer()">Register Producer</button><br>

  <input id="transporterAddress" placeholder="Transporter address 0x..." size="55">
  <button onclick="registerTransporter()">Register Transporter</button><br>

  <input id="distributorAddress" placeholder="Distributor address 0x..." size="55">
  <button onclick="registerDistributor()">Register Distributor</button><br>

  <input id="retailerAddress" placeholder="Retailer address 0x..." size="55">
  <button onclick="registerRetailer()">Register Retailer</button>
</div>

<!-- PRODUCER -->
<div id="producerSection" class="box" style="display:none;">
  <h3>Producer – Create Batch</h3>
  <input id="batchIdInput" type="number" placeholder="Batch ID"><br>
  <input id="productNameInput" placeholder="Product Name"><br>
  <input id="quantityInput" type="number" placeholder="Quantity"><br>
  <button onclick="createBatch()">Create Batch</button>
</div>

<!-- TRANSPORTER -->
<div id="transporterSection" class="box" style="display:none;">
  <h3>Transporter – Add Sensor Data</h3>
  <input id="sensorBatchIdInput" type="number" placeholder="Batch ID"><br>
  <input id="temperatureInput" type="number" placeholder="Temperature (°C)"><br>
  <input id="humidityInput" type="number" placeholder="Humidity (%)"><br>
  <input id="locationInput" placeholder="Location"><br>
  <button onclick="addSensorData()">Add Sensor Data</button>
</div>

<!-- DISTRIBUTOR -->
<div id="distributorSection" class="box" style="display:none;">
  <h3>Distributor – Transfer Ownership</h3>
  <input id="transferBatchIdInput" type="number" placeholder="Batch ID"><br>
  <input id="newOwnerInput" placeholder="New owner address 0x..." size="55"><br>
  <button onclick="transferOwnership()">Transfer Ownership</button>
</div>

<!-- RETAILER -->
<div id="retailerSection" class="box" style="display:none;">
  <h3>Retailer – Final Inspection</h3>
  <input id="retailerBatchIdInput" type="number" placeholder="Batch ID"><br>
  <select id="inspectionResult">
    <option value="true">Passed</option>
    <option value="false">Failed</option>
  </select><br>
  <button onclick="markAsArrived()">Mark As Arrived</button>
</div>

<!-- CUSTOMER -->
<div id="customerSection" class="box" style="display:none;">
  <h3>View Batch History</h3>
  <input id="historyBatchIdInput" type="number" placeholder="Batch ID">
  <button onclick="viewHistory()">Get History</button>
  <pre id="historyOutput"></pre>
</div>

<!-- Load Ethers.js (UMD build) -->
<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js" crossorigin="anonymous"></script>

<script>
window.addEventListener("load", () => {
  const statusEl   = document.getElementById("status");
  const connectBtn = document.getElementById("connectButton");
  const accountEl  = document.getElementById("accountDisplay");
  const networkEl  = document.getElementById("networkDisplay");
  const roleSelect = document.getElementById("roleSelect");

  // Make sure ethers is actually loaded
  const { ethers } = window;
  if (!ethers) {
    statusEl.textContent = "Status: ethers library failed to load";
    return;
  }

  const contractAddress = "0x0674873cF7Ca21d0d88cD075C0E52Bc0853c1Ad6";
  const SEPOLIA_CHAIN_ID = 11155111;

  const contractABI = [
    {
      "inputs":[
        {"internalType":"uint256","name":"batchId","type":"uint256"},
        {"internalType":"int256","name":"temperature","type":"int256"},
        {"internalType":"int256","name":"humidity","type":"int256"},
        {"internalType":"string","name":"location","type":"string"}
      ],
      "name":"addSensorData",
      "outputs":[],
      "stateMutability":"nonpayable",
      "type":"function"
    },
    {
      "inputs":[
        {"internalType":"uint256","name":"batchId","type":"uint256"},
        {"internalType":"string","name":"productName","type":"string"},
        {"internalType":"uint256","name":"quantity","type":"uint256"}
      ],
      "name":"createBatch",
      "outputs":[],
      "stateMutability":"nonpayable",
      "type":"function"
    },
    {
      "inputs":[
        {"internalType":"uint256","name":"batchId","type":"uint256"},
        {"internalType":"bool","name":"passedInspection","type":"bool"}
      ],
      "name":"markAsArrived",
      "outputs":[],
      "stateMutability":"nonpayable",
      "type":"function"
    },
    {
      "inputs":[{"internalType":"address","name":"producer","type":"address"}],
      "name":"registerProducer",
      "outputs":[],
      "stateMutability":"nonpayable",
      "type":"function"
    },
    {
      "inputs":[{"internalType":"address","name":"transporter","type":"address"}],
      "name":"registerTransporter",
      "outputs":[],
      "stateMutability":"nonpayable",
      "type":"function"
    },
    {
      "inputs":[{"internalType":"address","name":"distributor","type":"address"}],
      "name":"registerDistributor",
      "outputs":[],
      "stateMutability":"nonpayable",
      "type":"function"
    },
    {
      "inputs":[{"internalType":"address","name":"retailer","type":"address"}],
      "name":"registerRetailer",
      "outputs":[],
      "stateMutability":"nonpayable",
      "type":"function"
    },
    {
      "inputs":[
        {"internalType":"uint256","name":"batchId","type":"uint256"},
        {"internalType":"address","name":"newOwner","type":"address"}
      ],
      "name":"transferOwnership",
      "outputs":[],
      "stateMutability":"nonpayable",
      "type":"function"
    },
    {
      "inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"}],
      "name":"getBatchHistory",
      "outputs":[
        {
          "components":[
            {"internalType":"uint256","name":"batchId","type":"uint256"},
            {"internalType":"string","name":"productName","type":"string"},
            {"internalType":"uint256","name":"quantity","type":"uint256"},
            {"internalType":"address","name":"currentOwner","type":"address"},
            {"internalType":"bool","name":"created","type":"bool"},
            {"internalType":"bool","name":"arrived","type":"bool"},
            {"internalType":"bool","name":"passedInspection","type":"bool"},
            {
              "components":[
                {"internalType":"int256","name":"temperature","type":"int256"},
                {"internalType":"int256","name":"humidity","type":"int256"},
                {"internalType":"string","name":"location","type":"string"},
                {"internalType":"uint256","name":"timestamp","type":"uint256"}
              ],
              "internalType":"struct FreshChain.SensorLog[]",
              "name":"sensorHistory",
              "type":"tuple[]"
            },
            {
              "internalType":"address[]",
              "name":"ownershipHistory",
              "type":"address[]"
            }
          ],
          "internalType":"struct FreshChain.Batch",
          "name":"",
          "type":"tuple"
        }
      ],
      "stateMutability":"view",
      "type":"function"
    }
  ];

  let provider, signer, contract;

  function requireContract() {
    if (!contract) {
      alert("Please connect MetaMask first.");
      throw new Error("Contract not initialized");
    }
  }

  connectBtn.onclick = async () => {
    try {
      statusEl.textContent = "Status: connecting…";

      if (!window.ethereum) {
        statusEl.textContent = "Status: MetaMask not found";
        alert("MetaMask extension is not installed.");
        return;
      }

      await window.ethereum.request({ method: "eth_requestAccounts" });

      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer   = provider.getSigner();
      contract = new ethers.Contract(contractAddress, contractABI, signer);

      const account = await signer.getAddress();
      accountEl.textContent = "Connected: " + account;

      const net = await provider.getNetwork();
      networkEl.textContent = "Network: " + net.name + " (chainId " + net.chainId + ")";

      if (Number(net.chainId) !== SEPOLIA_CHAIN_ID) {
        alert("⚠ Please switch MetaMask to the Sepolia test network.");
      }

      statusEl.textContent = "Status: connected.";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Status: " + (err.message || err);
    }
  };

  // Role UI
  roleSelect.onchange = () => {
    ["admin","producer","transporter","distributor","retailer","customer"]
      .forEach(r => document.getElementById(r + "Section").style.display = "none");
    if (roleSelect.value) {
      document.getElementById(roleSelect.value + "Section").style.display = "block";
    }
    if (["producer","transporter","distributor","retailer","customer"].includes(roleSelect.value)) {
      document.getElementById("customerSection").style.display = "block";
    }
  };

  // Admin calls
  window.registerProducer = async () => {
    try {
      requireContract();
      await (await contract.registerProducer(producerAddress.value.trim())).wait();
      alert("Producer registered");
    } catch (e) { alert(e.message || e); }
  };
  window.registerTransporter = async () => {
    try {
      requireContract();
      await (await contract.registerTransporter(transporterAddress.value.trim())).wait();
      alert("Transporter registered");
    } catch (e) { alert(e.message || e); }
  };
  window.registerDistributor = async () => {
    try {
      requireContract();
      await (await contract.registerDistributor(distributorAddress.value.trim())).wait();
      alert("Distributor registered");
    } catch (e) { alert(e.message || e); }
  };
  window.registerRetailer = async () => {
    try {
      requireContract();
      await (await contract.registerRetailer(retailerAddress.value.trim())).wait();
      alert("Retailer registered");
    } catch (e) { alert(e.message || e); }
  };

  // Producer
  window.createBatch = async () => {
    try {
      requireContract();
      await (await contract.createBatch(
        Number(batchIdInput.value),
        productNameInput.value,
        Number(quantityInput.value)
      )).wait();
      alert("Batch created");
    } catch (e) { alert(e.message || e); }
  };

  // Transporter
  window.addSensorData = async () => {
    try {
      requireContract();
      await (await contract.addSensorData(
        Number(sensorBatchIdInput.value),
        Number(temperatureInput.value),
        Number(humidityInput.value),
        locationInput.value
      )).wait();
      alert("Sensor data added");
    } catch (e) { alert(e.message || e); }
  };

  // Distributor / owner
  window.transferOwnership = async () => {
    try {
      requireContract();
      await (await contract.transferOwnership(
        Number(transferBatchIdInput.value),
        newOwnerInput.value.trim()
      )).wait();
      alert("Ownership transferred");
    } catch (e) { alert(e.message || e); }
  };

  // Retailer
  window.markAsArrived = async () => {
    try {
      requireContract();
      await (await contract.markAsArrived(
        Number(retailerBatchIdInput.value),
        inspectionResult.value === "true"
      )).wait();
      alert("Arrival marked");
    } catch (e) { alert(e.message || e); }
  };

  // Customer
  window.viewHistory = async () => {
    try {
      requireContract();
      const b = await contract.getBatchHistory(Number(historyBatchIdInput.value));
      historyOutput.textContent = JSON.stringify(b, null, 2);
    } catch (e) { alert(e.message || e); }
  };
});
</script>

</body>
</html>
